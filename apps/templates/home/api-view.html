{% extends 'layouts/base.html' %}

{% block title %} API sample {% endblock title %}

{% block stylesheets %}
<style>
    #api-key-list {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid py-4">
    <!-- How it works section -->
    <div class="row mt-4">
        <div class="col-lg-12 mb-lg-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="d-flex flex-column h-100">
                                <p class="mb-1 pt-2 text-bold">How it works</p>
                                <h5 class="font-weight-bolder">Generated API</h5>
                                <p class="mb-3">
 This codebase provides secure user authentication and API key management features. Follow these steps to manage users and keys:
                                    <ul>
                                          <li><strong>Step #1</strong> - Register users via the "Register" endpoint</li>
        <li><strong>Step #2</strong> - Authenticate users using the "Login" endpoint to get a token</li>
        <li><strong>Step #3</strong> - Generate API keys for secure access to real-time data</li>
        <li><strong>Step #4</strong> - Use the API key to access IoT data at "http://localhost:5000/api/data"</li>
        <li><strong>Step #5</strong> - Manage users and keys via the admin dashboard</li>
                                    </ul>
                                </p>
                                <p>
                                    Import the
                                    <a class="text-primary" target="_blank" href="https://github.com/app-generator/flask-soft-ui-dashboard/tree/master/media">POSTMAN Sample collection <i class="fa fa-download"></i></a>
                                    and access the
                                    <a target="_blank" class="text-body text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="/api/">
                                        Generated API
                                        <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
                                    </a>
                                </p>
                            </div>
                        </div>
                        <div class="col-lg-4 ms-auto text-center mt-5 mt-lg-0">
                            <div class="bg-gradient-primary border-radius-lg h-100">
                                <div class="position-relative d-flex align-items-center justify-content-center h-100">
                                    <img class="w-100 position-relative z-index-2 pt-4" src="{{ config.ASSETS_ROOT }}/img/illustrations/rocket-white.png" alt="rocket">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Keys Section -->
    <div class="row">
        <div class="col-md-12 mt-4">
            <div class="card">
                <div class="card-header text-center pb-0 px-3">
                    <h6 class="mb-0">
                        <a class="btn btn-link text-dark px-3 mb-0" href="javascript:;" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                            <i class="fas fa-plus text-success me-2" aria-hidden="true"></i>Add API Key
                        </a>
                    </h6>
                </div>
                <div class="card-body pt-4 p-3">
                    <!-- Search Bar -->
                    <input type="text" class="form-control mb-3" id="api-key-search" placeholder="Search API keys..." onkeyup="filterApiKeys()">

                    <ul class="list-group" id="api-key-list">
                        <!-- Dynamic API key content will be inserted here by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% include "includes/footer.html" %}
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-labelledby="createApiKeyLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="create-api-key-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="createApiKeyLabel">Add API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Your new API key will be generated and displayed below:</p>
                    <div class="mb-3">
                        <label for="api_key">Generated API Key</label>
                        <input id="api_key" class="form-control" name="api_key" readonly>
                    </div>
                    <!-- Error Message -->
                    <p id="api-key-error" class="text-danger fw-bold"></p>
                    <!-- Loading Spinner -->
                    <div class="spinner-border text-primary" role="status" id="loading-spinner" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <input type="submit" class="btn btn-primary" value="Generate API Key">
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
 const token = sessionStorage.getItem('token') || '';  // Store token securely in sessionStorage
let apiKeyData = [];

// Utility function to display error messages
function showError(message) {
    document.getElementById('api-key-error').textContent = message;
}

// Fetch and display existing API keys on page load
function updateApiKeyList() {
    const apiKeyList = document.getElementById('api-key-list');
    apiKeyList.innerHTML = ''; // Clear previous list

    apiKeyData.forEach(apiKey => {
        const apiKeyItem = `
            <li class="list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
                <div class="d-flex flex-column">
                    <span class="text-xs">id: <span class="text-dark ms-sm-2 font-weight-bold">${apiKey.id}</span></span>
                    <span class="text-xs">API Key: <span class="text-dark ms-sm-2 font-weight-bold">${apiKey.api_key}</span></span>
                    <span class="text-xs">Created At: <span class="text-dark ms-sm-2 font-weight-bold">${new Date(apiKey.created_at).toLocaleDateString()}</span></span>
                </div>
                <div class="ms-auto text-end">
                    <a class="btn btn-link text-danger text-gradient px-3 mb-0 delete" href="javascript:;" onclick="deleteAction(${apiKey.id})">
                        <i class="far fa-trash-alt me-2"></i>Delete
                    </a>
                </div>
            </li>
        `;
        apiKeyList.insertAdjacentHTML('beforeend', apiKeyItem);
    });
}

// Function to fetch API keys from backend
function fetchApiKeys() {
    fetch('/api/apikeys/', {
        method: 'GET',
        headers: {
            "Authorization": `Bearer ${token}`,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            apiKeyData = data.data;  // Update apiKeyData array
            updateApiKeyList();      // Display keys
        } else {
            showError('Failed to load API keys.');
        }
    })
    .catch(err => {
        console.error('Error fetching API keys:', err);
        showError('Error loading API keys.');
    });
}

// Call this function when the page loads to fetch API keys
fetchApiKeys();

// Create API Key Form Submission
document.getElementById('create-api-key-form').onsubmit = (e) => {
    e.preventDefault();

    // Show loading spinner
    document.getElementById('loading-spinner').style.display = 'block';

    // API call to generate an API key
    fetch('/api/apikeys/', {
        method: 'POST',
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            // Any required data for key generation can be sent here
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading-spinner').style.display = 'none';  // Hide spinner
        if (data.success) {
            document.getElementById('api_key').value = data.key;  // Display the generated key to the user
            apiKeyData.push({
                id: data.id,
                api_key: data.key,
                created_at: new Date().toISOString()  // Add generated key to local data
            });
            updateApiKeyList();  // Refresh the displayed list
        } else {
            showError(data.message);  // Display error message
        }
    })
    .catch(err => {
        document.getElementById('loading-spinner').style.display = 'none';  // Hide spinner on error
        console.error('Error creating API key:', err);
        showError('An error occurred. Please try again.');
    });
};

// Delete API Key
function deleteAction(id) {
    if (confirm('Are you sure you want to delete this API key?')) {
        fetch(`/api/apikeys/${id}/`, {
            method: 'DELETE',
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                apiKeyData = apiKeyData.filter(apiKey => apiKey.id !== id);  // Remove deleted key from array
                updateApiKeyList();  // Refresh the displayed list
            } else {
                showError(data.message);  // Handle error if deletion fails
            }
        })
        .catch(err => {
            console.error('Error deleting API key:', err);
            showError('Error deleting API key.');
        });
    }
}

// Filter API keys by search input
function filterApiKeys() {
    const searchTerm = document.getElementById('api-key-search').value.toLowerCase();
    apiKeyData.forEach((apiKey, index) => {
        const listItem = document.querySelector(`#api-key-list li:nth-child(${index + 1})`);
        if (apiKey.api_key.toLowerCase().includes(searchTerm)) {
            listItem.style.display = 'block';
        } else {
            listItem.style.display = 'none';
        }
    });
}

// Attach event listener for the search input
document.getElementById('api-key-search').addEventListener('input', filterApiKeys);

</script>
{% endblock javascripts %}
